#!/bin/bash
# Cleanup worktree and branch without merging

set -e

# Configuration
MAIN_REPO=$(git rev-parse --show-toplevel)
WORKTREE_BASE="${MAIN_REPO}-work"
BRANCH_PREFIX="cc"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Usage
if [ $# -lt 1 ]; then
  echo "Usage: $0 <feature-name>"
  echo ""
  echo "This will DELETE the worktree and branch without merging!"
  echo ""
  exit 1
fi

FEATURE_NAME=$1
BRANCH_NAME="${BRANCH_PREFIX}/${FEATURE_NAME}"
WORKTREE_PATH="${WORKTREE_BASE}/${FEATURE_NAME}"

echo -e "${RED}⚠️  This will DELETE the worktree and branch WITHOUT merging!${NC}"
echo ""
echo "  Worktree: $WORKTREE_PATH"
echo "  Branch:   $BRANCH_NAME"
echo ""
read -p "Are you sure? (y/n) " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Cancelled."
  exit 0
fi

# Go to main repo
cd "$MAIN_REPO"

# Remove worktree
if [ -d "$WORKTREE_PATH" ]; then
  echo -e "${GREEN}✓${NC} Removing worktree..."
  git worktree remove "$WORKTREE_PATH" --force
else
  echo -e "${YELLOW}Worktree not found, skipping...${NC}"
fi

# Delete branch
if git show-ref --verify --quiet refs/heads/$BRANCH_NAME; then
  echo -e "${GREEN}✓${NC} Deleting branch..."
  git branch -D "$BRANCH_NAME"
else
  echo -e "${YELLOW}Branch not found, skipping...${NC}"
fi

echo ""
echo -e "${GREEN}✓ Cleaned up!${NC}"
echo ""
