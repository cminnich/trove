#!/bin/bash
# Sync current worktree with latest main branch

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}Syncing with main branch...${NC}"
echo ""

# Get current branch
CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ]; then
  echo -e "${YELLOW}Already on main branch. Just pulling...${NC}"
  git pull --rebase origin main 2>/dev/null || echo "No remote or already up to date"
  exit 0
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
  echo -e "${RED}✗ You have uncommitted changes. Commit or stash them first.${NC}"
  echo ""
  git status --short
  exit 1
fi

# Fetch latest main
echo -e "${GREEN}✓${NC} Fetching latest main..."
git fetch origin main:main 2>/dev/null || echo "No remote configured"

# Rebase current branch on main
echo -e "${GREEN}✓${NC} Rebasing $CURRENT_BRANCH on main..."
git rebase main

echo ""
echo -e "${GREEN}✓ Synced with main!${NC}"
echo ""
echo "If there were conflicts, resolve them and run: git rebase --continue"
echo ""
